<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç System Live Monitor - Immortal Chat OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b' } // Custom dark shade if needed
                    },
                    fontFamily: {
                        mono: ['JetBrains Mono', 'Fira Code', 'Consolas', 'monospace'],
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            /* Custom Scrollbar */
            .custom-scrollbar::-webkit-scrollbar {
                width: 8px;
            }
            .custom-scrollbar::-webkit-scrollbar-track {
                @apply bg-slate-900;
            }
            .custom-scrollbar::-webkit-scrollbar-thumb {
                @apply bg-slate-600 rounded hover:bg-slate-500;
            }

            /* Log Levels - S·ª≠ d·ª•ng @apply ƒë·ªÉ t√°i s·ª≠ d·ª•ng class Tailwind */
            .log-line {
                @apply px-2 py-0.5 rounded mb-0.5 border-l-4 border-transparent hover:bg-white/5 transition-colors whitespace-pre-wrap break-all;
            }
            .log-line.error {
                @apply text-red-400 bg-red-500/10 border-red-500;
            }
            .log-line.warn {
                @apply text-amber-400 bg-amber-500/10 border-amber-500;
            }
            .log-line.info {
                @apply text-sky-400 border-sky-500;
            }
            .log-line.debug {
                @apply text-slate-400;
            }
            .log-line.critical {
                @apply text-pink-400 bg-pink-500/15 border-pink-500 font-bold;
            }
            .log-line.filtered {
                @apply hidden;
            }
        }
    </style>
</head>

<body class="bg-slate-900 text-emerald-500 font-mono h-screen flex flex-col overflow-hidden">

    <div
        class="flex items-center justify-between px-5 py-3 bg-gradient-to-b from-slate-800 to-slate-900 border-b border-slate-700 flex-wrap gap-4 shrink-0 z-10">

        <div class="flex items-center gap-4">
            <div class="text-xl font-bold text-emerald-500 flex items-center gap-2">
                <span>‚ö°</span> System Live Monitor
            </div>

            <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-800 border border-slate-700 text-sm">
                <div id="statusDot"
                    class="w-2.5 h-2.5 rounded-full bg-amber-500 shadow-[0_0_8px_rgba(245,158,11,1)] animate-pulse">
                </div>
                <span id="statusText">ƒêang k·∫øt n·ªëi...</span>
            </div>

            <span id="pausedBadge" class="hidden bg-amber-500 text-slate-900 px-2 py-0.5 rounded text-xs font-bold">‚è∏
                PAUSED</span>
        </div>

        <div class="flex-1 max-w-xl">
            <input type="text" id="filterInput"
                class="w-full bg-slate-800 border border-slate-700 text-slate-200 px-4 py-2 rounded-md focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition-all text-sm placeholder-slate-500"
                placeholder="üîç Filter: ERROR, Webhook, Panic...">
        </div>

        <div class="flex gap-2">
            <button id="pauseBtn"
                class="flex items-center gap-2 px-4 py-2 bg-slate-800 border border-slate-700 text-slate-200 rounded-md hover:bg-slate-700 transition-colors text-sm">
                <span id="pauseIcon">‚è∏</span>
                <span id="pauseText">Pause</span>
            </button>
            <button id="clearBtn"
                class="flex items-center gap-2 px-4 py-2 bg-slate-800 border border-red-500 text-red-500 rounded-md hover:bg-red-500 hover:text-slate-900 transition-colors text-sm">
                üóë Clear
            </button>
        </div>
    </div>

    <div class="flex-1 overflow-hidden relative flex flex-col">
        <div id="console" class="flex-1 overflow-y-auto p-5 text-[13px] leading-relaxed custom-scrollbar">
            <div class="log-line info">
                <span class="text-slate-500 mr-2">[--:--:--]</span>
                ƒêang k·∫øt n·ªëi WebSocket...
            </div>
        </div>
    </div>

    <div
        class="flex justify-between items-center px-5 py-2 bg-slate-800 border-t border-slate-700 text-xs text-slate-500 shrink-0">
        <div class="flex gap-6">
            <div class="flex items-center gap-1.5">
                <span>üìä Total Lines:</span>
                <span id="totalLines" class="text-slate-200 font-bold">0</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span>üîç Visible:</span>
                <span id="visibleLines" class="text-slate-200 font-bold">0</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span>‚è± Last Update:</span>
                <span id="lastUpdate" class="text-slate-200 font-bold">--:--:--</span>
            </div>
        </div>
        <div>Immortal Chat OS v2.0 | Ctrl+F = Browser Search</div>
    </div>

    <script>
        // =================================================================
        // CONFIGURATION
        // =================================================================
        const MAX_LOG_LINES = 5000;

        const urlParams = new URLSearchParams(window.location.search);
        const secretKey = urlParams.get('secret_key') || '';
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}/ws/logs?secret_key=${encodeURIComponent(secretKey)}`;

        // =================================================================
        // STATE
        // =================================================================
        let ws = null;
        let isPaused = false;
        let totalLines = 0;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 10;
        const reconnectDelay = 3000;

        // DOM Elements
        const consoleEl = document.getElementById('console');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const pauseBtn = document.getElementById('pauseBtn');
        const pauseIcon = document.getElementById('pauseIcon');
        const pauseText = document.getElementById('pauseText');
        const pausedBadge = document.getElementById('pausedBadge');
        const clearBtn = document.getElementById('clearBtn');
        const filterInput = document.getElementById('filterInput');
        const totalLinesEl = document.getElementById('totalLines');
        const visibleLinesEl = document.getElementById('visibleLines');
        const lastUpdateEl = document.getElementById('lastUpdate');

        const CRITICAL_KEYWORDS = [
            'Disk Full', 'Tr√†n ·ªï c·ª©ng', 'disk_full',
            'Token Death', 'Token ch·∫øt', 'token_expired', 'ErrTokenExpired',
            'Bot Loop', 'Bot l·∫∑p', 'bot_loop',
            'Master-Master', 'master_conflict',
            'Panic', 'PANIC', 'panic:',
            'FATAL', 'Fatal'
        ];

        // =================================================================
        // WEBSOCKET CONNECTION
        // =================================================================
        function connect() {
            if (!secretKey) {
                setStatus('disconnected', '‚ùå Missing secret_key');
                addLogLine('[SYSTEM] Truy c·∫≠p: /static/monitor.html?secret_key=YOUR_MESH_SECRET', 'error');
                return;
            }

            setStatus('connecting', 'ƒêang k·∫øt n·ªëi...');

            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = function () {
                    setStatus('connected', '‚úÖ ƒê√£ k·∫øt n·ªëi');
                    reconnectAttempts = 0;
                    addLogLine('[SYSTEM] WebSocket k·∫øt n·ªëi th√†nh c√¥ng!', 'info');
                };

                ws.onmessage = function (event) {
                    if (!isPaused) {
                        const messages = event.data.split('\n');
                        messages.forEach(msg => {
                            if (msg.trim()) {
                                addLogLine(msg);
                            }
                        });
                    }
                };

                ws.onclose = function (event) {
                    setStatus('disconnected', 'üî¥ M·∫•t k·∫øt n·ªëi');
                    addLogLine(`[SYSTEM] WebSocket ƒë√≥ng (code: ${event.code})`, 'warn');

                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        setTimeout(() => {
                            addLogLine(`[SYSTEM] ƒêang th·ª≠ k·∫øt n·ªëi l·∫°i... (${reconnectAttempts}/${maxReconnectAttempts})`, 'warn');
                            connect();
                        }, reconnectDelay);
                    } else {
                        addLogLine('[SYSTEM] Kh√¥ng th·ªÉ k·∫øt n·ªëi l·∫°i. Vui l√≤ng refresh trang.', 'error');
                    }
                };

                ws.onerror = function (error) {
                    addLogLine('[SYSTEM] L·ªói WebSocket - Ki·ªÉm tra secret_key', 'error');
                };
            } catch (e) {
                addLogLine(`[SYSTEM] L·ªói: ${e.message}`, 'error');
            }
        }

        // =================================================================
        // LOG LINE MANAGEMENT
        // =================================================================
        function addLogLine(text, forceLevel = null) {
            const lineEl = document.createElement('div');
            lineEl.className = 'log-line'; // Base class from Tailwind layer

            // Determine log level
            let level = forceLevel || detectLogLevel(text);

            // [FIX L·ªñI] Ki·ªÉm tra level c√≥ gi√° tr·ªã kh√¥ng tr∆∞·ªõc khi add
            if (level && level.trim() !== '') {
                lineEl.classList.add(level);
            }

            // Check for critical keywords
            if (isCriticalLog(text)) {
                lineEl.classList.add('critical');
            }

            const timestamp = new Date().toLocaleTimeString('vi-VN');
            lineEl.innerHTML = `<span class="text-slate-500 mr-2">[${timestamp}]</span>${escapeHtml(text)}`;

            // Store for filtering
            lineEl.dataset.text = text.toLowerCase();

            // Apply filter
            const filterText = filterInput.value.toLowerCase();
            if (filterText && !lineEl.dataset.text.includes(filterText)) {
                lineEl.classList.add('filtered');
            }

            consoleEl.appendChild(lineEl);
            totalLines++;

            // Auto-purge
            while (consoleEl.children.length > MAX_LOG_LINES) {
                consoleEl.removeChild(consoleEl.firstChild);
            }

            // Auto-scroll
            if (!isPaused) {
                consoleEl.scrollTop = consoleEl.scrollHeight;
            }

            updateStats();
        }

        function detectLogLevel(text) {
            const upper = text.toUpperCase();
            if (upper.includes('[ERROR]') || upper.includes('ERROR:') || upper.includes('‚ùå')) return 'error';
            if (upper.includes('[WARN]') || upper.includes('WARNING') || upper.includes('‚ö†Ô∏è')) return 'warn';
            if (upper.includes('[INFO]') || upper.includes('INFO:') || upper.includes('‚úÖ') || upper.includes('‚úì')) return 'info';
            if (upper.includes('[DEBUG]') || upper.includes('DEBUG:')) return 'debug';
            return ''; // Tr·∫£ v·ªÅ r·ªóng n·∫øu kh√¥ng kh·ªõp
        }

        function isCriticalLog(text) {
            const lower = text.toLowerCase();
            return CRITICAL_KEYWORDS.some(keyword => lower.includes(keyword.toLowerCase()));
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // =================================================================
        // UI CONTROLS
        // =================================================================
        function setStatus(status, text) {
            // Tailwind classes for status dot
            statusDot.className = 'w-2.5 h-2.5 rounded-full shadow-[0_0_8px] '; // Reset base

            if (status === 'connected') {
                statusDot.classList.add('bg-emerald-500', 'shadow-emerald-500', 'animate-pulse');
            } else if (status === 'disconnected') {
                statusDot.classList.add('bg-red-500', 'shadow-red-500');
            } else if (status === 'connecting') {
                statusDot.classList.add('bg-amber-500', 'shadow-amber-500', 'animate-pulse');
            }

            statusText.textContent = text;
        }

        function togglePause() {
            isPaused = !isPaused;
            if (isPaused) {
                pauseIcon.textContent = '‚ñ∂';
                pauseText.textContent = 'Resume';
                pauseBtn.classList.replace('bg-slate-800', 'bg-emerald-600');
                pauseBtn.classList.replace('text-slate-200', 'text-white');
                pausedBadge.classList.remove('hidden');
            } else {
                pauseIcon.textContent = '‚è∏';
                pauseText.textContent = 'Pause';
                pauseBtn.classList.replace('bg-emerald-600', 'bg-slate-800');
                pauseBtn.classList.replace('text-white', 'text-slate-200');
                pausedBadge.classList.add('hidden');
                consoleEl.scrollTop = consoleEl.scrollHeight;
            }
        }

        function clearConsole() {
            consoleEl.innerHTML = '';
            totalLines = 0;
            addLogLine('[SYSTEM] Console ƒë√£ ƒë∆∞·ª£c x√≥a', 'info');
        }

        function applyFilter() {
            const filterText = filterInput.value.toLowerCase();
            const lines = consoleEl.querySelectorAll('.log-line');

            lines.forEach(line => {
                if (!filterText || line.dataset.text.includes(filterText)) {
                    line.classList.remove('filtered');
                } else {
                    line.classList.add('filtered');
                }
            });
            updateStats();
        }

        function updateStats() {
            const visibleCount = consoleEl.querySelectorAll('.log-line:not(.filtered)').length;
            totalLinesEl.textContent = totalLines.toLocaleString();
            visibleLinesEl.textContent = visibleCount.toLocaleString();
            lastUpdateEl.textContent = new Date().toLocaleTimeString('vi-VN');
        }

        // =================================================================
        // EVENT LISTENERS
        // =================================================================
        pauseBtn.addEventListener('click', togglePause);
        clearBtn.addEventListener('click', clearConsole);
        filterInput.addEventListener('input', applyFilter);

        document.addEventListener('keydown', function (e) {
            if (e.code === 'Space' && document.activeElement !== filterInput) {
                e.preventDefault();
                togglePause();
            }
            if (e.code === 'Escape') {
                filterInput.value = '';
                applyFilter();
            }
            if (e.key === '/' && document.activeElement !== filterInput) {
                e.preventDefault();
                filterInput.focus();
            }
        });

        // =================================================================
        // INITIALIZE
        // =================================================================
        connect();
    </script>
</body>

</html>