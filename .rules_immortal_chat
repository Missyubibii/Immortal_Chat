D·ª±a tr√™n vi·ªác ph√¢n t√≠ch s√¢u to√†n b·ªô b·ªô t√†i li·ªáu k·ªπ thu·∫≠t b·∫°n cung c·∫•p (ƒë·∫∑c bi·ªát l√† c√°c file `core he thong loi.docx`, `corev2.docx`, v√† `ƒê·∫∑c t·∫£ API Chi ti·∫øt.docx`), t√¥i ƒë√£ ph√°t hi·ªán m·ªôt s·ªë ƒëi·ªÉm **c·ªët t·ª≠** c√≤n thi·∫øu trong b·ªô rule c≈© (nh∆∞ C·∫•u tr√∫c ph·∫£n h·ªìi chu·∫©n, C∆° ch·∫ø Backpressure khi qu√° t·∫£i, v√† Quy t·∫Øc ID ph√¢n t√°n ƒë·ªÉ tr√°nh s·∫≠p h·ªá th·ªëng).

D∆∞·ªõi ƒë√¢y l√† phi√™n b·∫£n **FINALIZED** c·ªßa b·ªô lu·∫≠t `.rulesgemini`. T√¥i ƒë√£ l√†m s·∫°ch c√°c th·∫ª r√°c (`[cite_start]`), b·ªï sung c√°c c∆° ch·∫ø b·∫£o v·ªá t·ª´ t√†i li·ªáu "S·ª± c·ªë", v√† chu·∫©n h√≥a theo ƒë√∫ng ki·∫øn tr√∫c L·ª•c Gi√°c.

H√£y copy to√†n b·ªô n·ªôi dung trong block code d∆∞·ªõi ƒë√¢y v√†o file `.rulesgemini`.

---

### üìú FILE: .rulesgemini (Phi√™n b·∫£n Ho√†n Ch·ªânh)

```markdown
# IMMORTAL CHAT OS - SYSTEM CONSTITUTION & CODING RULES (FINAL V2.1)

## 1. TECH STACK & INFRASTRUCTURE (GOLDEN STACK)
- **Language:** Go (Golang) v1.22+. ∆Øu ti√™n s·ª≠ d·ª•ng Standard Library (`net/http`) thay v√¨ Framework n·∫∑ng.
- **Database:** MariaDB 11.4 LTS (Hot Layer).
- **Cache:** Redis 7.2 Alpine (Pub/Sub, Dedup, Queue).
- **Environment:** Docker Containerization (Alpine Linux base).
- **Networking:** Mesh Topology qua Cloudflare Tunnel. Kh√¥ng m·ªü Port Public (80/443).
- **ID Strategy:** B·∫Øt bu·ªôc c·∫•u h√¨nh `auto_increment_increment` v√† `auto_increment_offset` kh√°c nhau cho t·ª´ng Node ƒë·ªÉ tr√°nh tr√πng ID khi g·ªôp d·ªØ li·ªáu (Master-Master Conflict).

## 2. ARCHITECTURAL PATTERNS (HEXAGONAL ARCHITECTURE)
- **Structure Enforcement:**
  - `internal/core`: Ch·ª©a Business Logic thu·∫ßn t√∫y (Service, Domain Models). KH√îNG import `database`, `http`, hay th∆∞ vi·ªán b√™n ngo√†i.
  - `internal/adapters`: Ch·ª©a code giao ti·∫øp (HTTP Handlers, SQL Repositories, Redis Client, Facebook Client).
  - `internal/infra`: Ch·ª©a Config, Logger, Connection Pooling.
- **Dependency Rule:** `Core` ƒë·ªôc l·∫≠p tuy·ªát ƒë·ªëi. `Adapters` ph·ª• thu·ªôc v√†o `Core` th√¥ng qua Interfaces (Ports).

## 3. DATA STRATEGY (FEDERATED & LOCAL-FIRST)
- **Local-First:** M·ªçi d·ªØ li·ªáu (Tin nh·∫Øn, Log, Webhook) ph·∫£i ƒë∆∞·ª£c l∆∞u b·ªÅn v·ªØng v√†o MariaDB Local ngay l·∫≠p t·ª©c.
- **Sync-Later:** ƒê·ªìng b·ªô v·ªÅ Home Server l√† t√°c v·ª• ch·∫°y ng·∫ßm (Background), c√≥ c∆° ch·∫ø Retry.
- **Data Lifecycle:**
  - B·∫£ng `messages`, `webhook_logs` b·∫Øt bu·ªôc c√≥ c·ªôt `is_synced` (BOOLEAN, Default 0).
  - Ch·ªâ update `is_synced = 1` khi nh·∫≠n ƒë∆∞·ª£c x√°c nh·∫≠n th√†nh c√¥ng t·ª´ Home Server.
  - D·ªØ li·ªáu n√≥ng (Hot Data) l∆∞u t·∫°i Local 7 ng√†y. D·ªØ li·ªáu l·∫°nh (Cold Data) n·∫±m ·ªü Home Server.

## 4. INGRESS & WEBHOOK LOGIC (FIRE & FORGET)
- **Performance:** API Webhook (`POST /webhook/:platform`) b·∫Øt bu·ªôc ph·∫£n h·ªìi `HTTP 200 OK` trong < 3 gi√¢y (Hard Limit).
- **Flow:** Nh·∫≠n JSON -> Validate HMAC -> Check Dedup -> Push to Queue/Channel -> Return 200 OK.
- **Heavy Logic:** Tuy·ªát ƒë·ªëi KH√îNG g·ªçi AI, Upload File, hay Query ph·ª©c t·∫°p trong lu·ªìng Webhook ch√≠nh.
- **Deduplication:** Ki·ªÉm tra Redis Key `dedup:msg:{platform_msg_id}` (TTL 10 ph√∫t). N·∫øu t·ªìn t·∫°i -> Return 200 OK ngay (Idempotency).
- **Backpressure:** Khi CPU > 90%, chuy·ªÉn sang ch·∫ø ƒë·ªô "Store-Only" (Ch·ªâ l∆∞u Queue, kh√¥ng x·ª≠ l√Ω) ƒë·ªÉ tr√°nh s·∫≠p Node.

## 5. SELF-HEALING & WATCHDOG (AUTO-PURGE)
- **Watchdog Service:** Ch·∫°y ƒë·ªãnh k·ª≥ (10 ph√∫t/l·∫ßn).
- **Purge Rules:** Ch·ªâ th·ª±c hi·ªán l·ªánh DELETE khi th·ªèa m√£n ƒê·ª¶ 3 ƒëi·ªÅu ki·ªán:
  1. Disk Usage > 70%.
  2. D·ªØ li·ªáu c≈© h∆°n 7 ng√†y (Retention Policy).
  3. `is_synced = 1` (ƒê√£ an to√†n ·ªü Home Server).
- **Safety:** X√≥a theo l√¥ (Batch Limit 1000) ƒë·ªÉ tr√°nh kh√≥a b·∫£ng (Table Lock). Tuy·ªát ƒë·ªëi kh√¥ng x√≥a d·ªØ li·ªáu ch∆∞a Sync (`is_synced=0`).

## 6. MESH COMMUNICATION & SECURITY
- **Internal Auth:** C√°c API n·ªôi b·ªô (`/internal/*`) b·∫Øt bu·ªôc ki·ªÉm tra Header `X-Mesh-Secret` (Load t·ª´ `.env`).
- **Orphan Mode:** Khi m·∫•t k·∫øt n·ªëi Tunnel v·ªÅ Home Server:
  - H·ªá th·ªëng v·∫´n ph·∫£i nh·∫≠n tin v√† Chat Realtime b√¨nh th∆∞·ªùng (D√πng Cache Local).
  - C√°c thao t√°c nh·∫°y c·∫£m (Audit) l∆∞u v√†o DB Local, ch·ªù c√≥ m·∫°ng Replay sau.
- **Kill Switch:** Ki·ªÉm tra bi·∫øn Redis `SYSTEM_STATUS`. N·∫øu = `PANIC`, ng·∫Øt to√†n b·ªô lu·ªìng Webhook ƒë·ªÉ ch·ªëng DDoS/Loop.

## 7. CODING STANDARDS & API RESPONSE
- **Response Envelope:** M·ªçi API JSON (tr·ª´ Webhook) ph·∫£i tr·∫£ v·ªÅ ƒë√∫ng ƒë·ªãnh d·∫°ng:
  ```json
  {
    "code": 200,
    "message": "Success",
    "data": {...},
    "trace_id": "req_uuid"
  }

```

* **Error Handling:** S·ª≠ d·ª•ng `recover()` trong m·ªçi Goroutines ƒë·ªÉ tr√°nh App Crash. Log l·ªói Critical v·ªÅ Telegram/Central Log.
* **Configuration:** Load to√†n b·ªô c·∫•u h√¨nh t·ª´ bi·∫øn m√¥i tr∆∞·ªùng (Environment Variables). Kh√¥ng hard-code Password/Token.

```

---

### Ph√¢n t√≠ch c√°c thay ƒë·ªïi & b·ªï sung quan tr·ªçng:

1.  **Th√™m quy t·∫Øc "ID Strategy" (M·ª•c 1):**
    * *L√Ω do:* T√†i li·ªáu `core he thong loi.docx` c·∫£nh b√°o l·ªói "Master-Master Conflict"[cite: 1905]. N·∫øu kh√¥ng set `auto_increment_offset`, d·ªØ li·ªáu t·ª´ c√°c Node khi g·ªôp v·ªÅ s·∫Ω b·ªã tr√πng ID kh√≥a ch√≠nh, l√†m s·∫≠p Database. ƒê√¢y l√† b·ªï sung s·ªëng c√≤n.

2.  **C∆° ch·∫ø "Backpressure" (M·ª•c 4):**
    * [cite_start]*L√Ω do:* T√†i li·ªáu `core he thong loi.docx` nh·∫Øc ƒë·∫øn l·ªói "T·∫Øc ngh·∫Ωn Webhook" [cite: 1918] [cite_start]v√† gi·∫£i ph√°p "Store-Only"[cite: 447]. Rule n√†y gi√∫p Server kh√¥ng b·ªã ch·∫øt khi Facebook g·ª≠i qu√° nhi·ªÅu tin c√πng l√∫c.

3.  **C·∫•u tr√∫c ph·∫£n h·ªìi chu·∫©n "Response Envelope" (M·ª•c 7):**
    * [cite_start]*L√Ω do:* T√†i li·ªáu `ƒê·∫∑c t·∫£ API Chi ti·∫øt.docx` [cite: 2223] quy ƒë·ªãnh m·ªçi API ph·∫£i tr·∫£ v·ªÅ JSON c√≥ `code`, `message`, `data`. N·∫øu AI code t·ª± do (tr·∫£ v·ªÅ raw string ho·∫∑c JSON kh√¥ng chu·∫©n), Frontend React s·∫Ω b·ªã l·ªói khi parse.

4.  **Kill Switch (M·ª•c 6):**
    * [cite_start]*L√Ω do:* ƒê·ªÉ x·ª≠ l√Ω k·ªãch b·∫£n "Bot Loop" (Bot t·ª± chat v·ªõi nhau v√¥ t·∫≠n) ƒë∆∞·ª£c nh·∫Øc trong `H·ªí S∆† THI·∫æT K·∫æ`[cite: 696].

B·ªô rule n√†y gi·ªù ƒë√¢y ƒë√£ bao ph·ªß c·∫£ **Ki·∫øn tr√∫c**, **D·ªØ li·ªáu**, **Quy tr√¨nh x·ª≠ l√Ω l·ªói** v√† **Giao di·ªán API**. B·∫°n c√≥ th·ªÉ y√™n t√¢m ƒë∆∞a cho AI s·ª≠ d·ª•ng.

```